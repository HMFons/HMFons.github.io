<!DOCTYPE html>
<html>

<body onload="loadFiles()">
    <p>Want to know what you're actual Spotify listens are? Ask them for your data in accordance with GDPR and input
        your streamingHistory.json files.</p>
    <input type="file" id="myFile" multiple size="50" onchange="loadFiles()">
    <p><strong>Tip:</strong> Use the Control or the Shift key to select multiple files.</p>

    <p id="demo"></p>
    <div>
        <button onclick="createArtistGroupedTable()">Group By Artist</button>
        <button onclick="createTrackGroupedTable()" disabled>Group By Track</button>
        <button onclick="groupBoth()">Group By Arist And Trackname</button>
        <button onclick="loadData()">Use Hans' Data</button>
    </div>
    <div id="table"></div>
    <script>
        var parsedJson = [];
        function loadFiles() {
            var x = document.getElementById("myFile");
            var txt = "";
            if ('files' in x) {
                if (x.files.length == 0) {
                    txt = "Select one or more files.";
                } else {
                    for (var i = 0; i < x.files.length; i++) {
                        txt += "<br><strong>" + (i + 1) + ". file</strong><br>";
                        var file = x.files[i];
                        if ('name' in file) {
                            txt += "name: " + file.name + "<br>";
                        }
                        if ('size' in file) {
                            txt += "size: " + file.size + " bytes <br>";
                        }
                        readJsonFile(file);
                    }
                }
            }
            else {
                if (x.value == "") {
                    txt += "Select one or more files.";
                } else {
                    txt += "The files property is not supported by your browser!";
                    txt += "<br>The path of the selected file: " + x.value; // If the browser does not support the files property, it will return the path of the selected file instead. 
                }
            }
            document.getElementById("demo").innerHTML = txt;
        }
        function readJsonFile(jsonFile) {
            var reader = new FileReader();
            reader.addEventListener('load', (loadEvent) => {
                try {
                    json = JSON.parse(loadEvent.target.result);
                    parsedJson = parsedJson.concat(json);
                    if (parsedJson.length > 30000) {
                        createTable(parsedJson);
                    }
                } catch (error) {
                    console.error(error);
                }
            });
            reader.readAsText(jsonFile);
        }
        function createTable(json) {
            var table = "<table><thead><th>Artist</th><th>Track</th><th>Played at</th></thead><tbody>"
            json.sort((a, b) => (a.artistName.toLowerCase() > b.artistName.toLowerCase()) ? 1 : ((b.artistName.toLowerCase() > a.artistName.toLowerCase()) ? -1 : (a.trackName.toLowerCase() > b.trackName.toLowerCase()) ? 1 : ((b.trackName.toLowerCase() > a.trackName.toLowerCase()) ? -1 : 0)))
                .forEach(x => table += "<tr><td>" + x.artistName + "</td><td>" + x.trackName + "</td><td>" + x.endTime + "</td></tr>");
            table += "</tbody></table>";
            document.getElementById("table").innerHTML = table;

        }
        function createArtistGroupedTable() {
            var json = groupTable(parsedJson, 'artistName')
            var table = "<table><thead><th>Artist</th><th>Track</th><th>AmountPlayed</th></thead><tbody>"
            var result = toArray(json);
            result.forEach(artist => {
                table += " <tr><td>" + artist[0] + "</td><td>" + artist[1].length + "</td></tr>";
                artist[1].sort((a, b) => (a.trackName > b.trackName) ? 1 : ((b.trackName > a.trackName) ? -1 : 0)).forEach(track => {
                    table += "<tr><td></td><td>" + track.trackName + "</td></tr>";
                })
            });
            table += "</tbody></table>";
            document.getElementById("table").innerHTML = table;
        }
        function createTrackGroupedTable() {
            var json = groupTable(parsedJson, 'trackName');
            throw "Not Implemented";
            var table = "<table><thead><th>Artist</th><th>Track</th><th>AmountPlayed</th></thead><tbody>"
            var result = toArray(json);
            result.forEach(artist => {
                table += " <tr><td>" + artist[0] + "</td><td></td><td>" + artist[1].length + "</td></tr>";
                artist[1].sort((a, b) => (a.trackName > b.trackName) ? 1 : ((b.trackName > a.trackName) ? -1 : 0)).forEach(track => {
                    table += "<tr><td></td><td>" + track.trackName + "</td></tr>";
                })
            });
            table += "</tbody></table>";
            document.getElementById("table").innerHTML = table;
        }
        function createGroupedTable(json) {
            var table = "<table><thead><th>Artist</th><th>Track</th><th>AmountPlayed</th></thead><tbody>"
            var result = toArray(json);
            result.forEach(artist => {
                table += " <tr><td>" + artist[0] + "</td><td>" + artist[1].length + "</td></tr>";
                artist[1].sort((a, b) => (a.trackName > b.trackName) ? 1 : ((b.trackName > a.trackName) ? -1 : 0)).forEach(track => {
                    table += "<tr><td></td><td>" + track[0] + "</td><td>" + track[1].length + "</td></tr>";
                })
            });
            table += "</tbody></table>";
            document.getElementById("table").innerHTML = table;
        }
        function groupTable(data, key) {
            var grouped = data.reduce(function (storage, item) {
                var group = item[key];

                storage[group] = storage[group] || [];

                storage[group].push(item);
                return storage;
            }, {});
            return grouped
        }
        function groupBoth() {
            var groupedByArtist = groupTable(parsedJson, 'artistName');
            var artistArray = toArray(groupedByArtist);
            var groupedByBoth = [];
            artistArray.forEach(x => {
                groupedByBoth[x[0]] = toArray(groupTable(x[1], 'trackName'));
            });
            createGroupedTable(groupedByBoth);
        }
        function toArray(json) {
            return Object.keys(json).map((key) => [key, json[key]]);
        }
        function loadData() {
            var allData = [];
            for (let index = 0; index < 4; index++) {
                fetch('StreamingHistory' + index + '.json', {
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    }
                }
                )
                    .then(res => {
                        if (!res.ok) {
                            throw new Error("HTTP error " + res.status);
                        }
                        return res.json();
                    })
                    .then(data => { allData = allData.concat(data); })
                    .then(() => { parsedJson = allData; createTable(allData) });
            }
        }
    </script>


</body>

</html>